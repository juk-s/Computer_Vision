# ЛР2 — Трекинг объекта на видео по ключевым точкам

## Цель работы

Реализовать простейший алгоритм трекинга объекта на видео на основе ключевых точек.

## 1. Теоретическая база

### 1.1. Ключевые точки и межкадровый трекинг (Lucas–Kanade)

Для набора опорных точек оценивается их смещение между соседними кадрами методом Lucas–Kanade (KLT), который работает при предположении малых смещений и локальной гладкости. В OpenCV используется пирамидальная реализация:

* `cv.calcOpticalFlowPyrLK(prev_gray, gray, p_prev, ...)`

### 1.2. Проективная модель (гомография)

Для плоского объекта соответствие координат между кадрами описывается гомографией:

**p' ~ H p**, где **H** — матрица 3×3 (проективное преобразование).

Оценённая матрица **H** используется для переноса рамки объекта на текущий кадр:

* `cv.perspectiveTransform(corners, H)`


### 1.3. Оценка гомографии с RANSAC

Из-за выбросов гомография оценивается с RANSAC, который отбирает согласованные пары (inliers):

* `cv.findHomography(src, dst, cv.RANSAC)`

### 1.4. Повторное обнаружение по дескрипторам (AKAZE)

При потере трекинга выполняется повторная локализация: детектирование AKAZE-признаков на текущем кадре и сопоставление с признаками первого кадра. Затем снова оценивается гомография и восстанавливается положение объекта.

* `cv.AKAZE_create().detectAndCompute(...)`
* `cv.BFMatcher(cv.NORM_HAMMING).knnMatch(...)`

---

## 2. Описание разработанной системы

### 2.1. Общая схема

Реализация состоит из двух режимов работы:

* **Tracking (LK + RANSAC):** межкадровое сопровождение точек и инкрементальное обновление рамки по гомографии.
* **Redetect (AKAZE):** восстановление положения объекта относительно первого кадра при потере трекинга.

Переход в режим `lost=True` выполняется при недостатке точек или при неуспешной оценке гомографии (мало inliers).

### 2.2. Инициализация (первый кадр)

1. Чтение первого кадра, перевод в grayscale.
2. Вычисление опорных признаков **AKAZE** на первом кадре: `kp0, des0`.
3. Задание начальной рамки `corners0` (в текущей реализации — границы кадра; это корректно при условии, что первый кадр является крупным планом объекта).
4. Засев точек для KLT **внутри рамки**:

   * создаётся маска полигона `cv.fillPoly`;
   * выбираются угловые точки `cv.goodFeaturesToTrack` по маске.

### 2.3. Основной цикл обработки кадров

Для каждого кадра:

1. Перевод в grayscale.

2. Если `lost == False`:

   * вычисление прямого и обратного оптического потока:

     * `p_next = calcOpticalFlowPyrLK(prev_gray → gray)`
     * `p_back = calcOpticalFlowPyrLK(gray → prev_gray)`
   
   * отбор валидных соответствий и оценка гомографии `H` методом RANSAC.
   * проверка качества: число inliers должно быть не меньше `MIN_INLIERS_LK`.
   * при успехе:

     * перенос рамки `corners = perspectiveTransform(corners, H)`;
     * обновление набора точек.
   * при неуспехе: `lost=True`.

3. Если `lost == True`:

   * `redetect(gray)`:

     * AKAZE на текущем кадре;
     * сопоставление с признаками первого кадра через BFMatcher (Hamming);
     * оценка абсолютной гомографии (H_{abs}) (первый кадр → текущий) методом RANSAC;
   * при успехе:

     * восстановление рамки `corners = perspectiveTransform(corners0, Habs)`;
     * повторный засев точек внутри рамки;
     * `lost=False`.


### 2.4. Параметры реализации

* `MAX_CORNERS = 1000` — максимум точек KLT внутри рамки
* `MIN_INLIERS_LK = 20` — минимально допустимое число inliers при RANSAC (для подтверждения обновления рамки)
* Предобработка для признаков: CLAHE `clipLimit=2.0`, `tileGridSize=(8, 8)`

### 2.5. Вход/выход

* Вход: `test-videos/<NAME>`
* Выход: `results/t1_<NAME>`

---

## 3. Результаты работы и тестирования системы

### 3.1. Тестирование на предоставленных видео

Алгоритм запускается на каждом тестовом видео заменой параметра `NAME`.

Рекомендуемый формат фиксации результатов:

| Видео                   | Результат | 
| ----------------------- | --------- |
| t1_mona-lisa.avi | OK |
| t1_mona-lisa-blur.avi | OK |          
| t1_mona-lisa-blur-extra-credit | OK |     

### 3.2. Тестирование на собственном видео

| Видео                    | Результат |
| ------------------------ | --------- | 
| t1_video_2 | OK |  

## 4. Выводы по работе

1. KLT обеспечивает быстрый межкадровый трекинг точек, но чувствителен к деградации изображения (размытие, перекрытия, сильные изменения масштаба/поворота).
2. Оценка гомографии с RANSAC позволяет устойчиво переносить рамку плоского объекта за счёт отбрасывания выбросов.
3. Механизм повторного обнаружения по AKAZE повышает устойчивость: при потере треков возможно восстановление положения объекта относительно первого кадра.

Практические направления улучшения:

* использовать порог по forward-backward ошибке `fb` при отборе треков;
* добавить ratio-test (Lowe) для `knnMatch` при AKAZE;
* контролировать минимальное число матчей при re-detect и качество RANSAC.

---

## 5. Использованные источники

* OpenCV Documentation: Lucas–Kanade Optical Flow, Homography, AKAZE, BFMatcher, `goodFeaturesToTrack`, CLAHE
* Wikipedia: Optical flow; Lucas–Kanade method; Homography; RANSAC
